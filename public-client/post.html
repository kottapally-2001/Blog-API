<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Post</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="min-h-screen bg-slate-50">
  <main class="max-w-3xl mx-auto px-4 py-8">
    <!-- ✅ Fixed back link -->
    <a href="http://localhost:5173/index.html" class="text-blue-600 hover:underline">← Back to Home</a>

    <!-- Post content -->
    <article id="post" class="bg-white rounded-2xl p-6 shadow mt-4"></article>

    <!-- Comments section -->
    <section class="bg-white rounded-2xl p-6 shadow mt-6">
      <h3 class="text-lg font-semibold">Comments</h3>

      <form id="commentForm" class="mt-4 grid gap-3">
        <input class="border rounded px-3 py-2" name="authorName" placeholder="Your name" required />
        <input class="border rounded px-3 py-2" name="authorEmail" placeholder="Your email (optional)" />
        <textarea class="border rounded px-3 py-2" name="content" placeholder="Write a comment..." required></textarea>
        <button class="bg-blue-600 text-white rounded px-4 py-2" type="submit">Add Comment</button>
      </form>

      <div id="comments" class="mt-6 grid gap-4"></div>
    </section>
  </main>

  <script type="module">
    import { api } from './js/api.js';

    const params = new URLSearchParams(location.search);
    const slug = params.get('slug');
    const postEl = document.getElementById('post');
    const commentsEl = document.getElementById('comments');

    // ✅ Load post and comments
    async function load() {
      try {
        const post = await api(`/posts/${slug}`);
        postEl.innerHTML = `
          <h1 class="text-3xl font-bold">${post.title}</h1>
          <p class="text-sm text-slate-500 mt-1">By ${post.author.username} • ${new Date(post.createdAt).toLocaleString()}</p>
          <div class="prose max-w-none mt-4">${post.content.replace(/\n/g, '<br/>')}</div>
        `;
        commentsEl.innerHTML = post.comments.length
          ? post.comments.map(c => `
            <div class="border rounded-xl p-4">
              <div class="text-sm text-slate-500">${c.authorName} • ${new Date(c.createdAt).toLocaleString()}</div>
              <p class="mt-1">${c.content}</p>
            </div>
          `).join('')
          : '<p class="text-slate-500">No comments yet.</p>';
      } catch (err) {
        postEl.innerHTML = `<p class="text-red-600">Error loading post: ${err.message}</p>`;
      }
    }

    // ✅ Handle comment form submission
    document.getElementById('commentForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const fd = new FormData(e.target);
      const body = Object.fromEntries(fd.entries());
      try {
        await api(`/comments/${slug}`, { method: 'POST', body: JSON.stringify(body) });
        e.target.reset();
        await load();
      } catch (err) {
        alert(err.message);
      }
    });

    load();
  </script>
</body>
</html>
